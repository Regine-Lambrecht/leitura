<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprendendo a leitura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Estilos CSS (style.css incorpor√©) */
        :root {
            --cor-principal: #3498db; /* BLEU */
            --cor-fundo: #ecf0f1;
            --cor-sucesso: #2ecc71; /* VERT (Succ√®s/Bravo) */
            --cor-erreur: #e74c3c;
            --cor-voltar: #3499db; /* BLEU para Voltar */
            --cor-reset: #e74c3c;
            --tamanho-letra: 28px; /* Aumentado para melhor legibilidade no mobile */
            /* NOVO: Fonte Sans-Serif moderna e limpa para mobile */
            --mobile-font: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--mobile-font); /* Alterado para Sans-Serif */
            background-color: var(--cor-fundo);
            color: #333;
            margin: 0;
            padding: 10px; /* Base padding for mobile */
            text-align: center;
        }

        .container {
            max-width: 600px; /* Mant√©m o limite, mas foca no mobile */
            margin: 0 auto;
            background: #fff;
            padding: 15px; /* Base padding for mobile */
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1, h2, h3 {
            font-family: var(--mobile-font); /* Alterado para Sans-Serif */
            color: var(--cor-principal);
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 1.6em; /* Ajuste para mobile */
        }
        h2 {
            font-size: 1.4em;
        }

        /* Se√ß√£o de Pontua√ß√£o et Messages */
        #score-container {
            margin-bottom: 20px;
            padding: 15px;
            border: none;
            background: #f9f9f9;
            border-radius: 10px;
            display: flex; 
            flex-direction: column; /* MOBILE FIRST: Stack image and text */
            align-items: center;
            justify-content: center;
            gap: 10px; /* Reduced gap */
            text-transform: uppercase;
            font-size: 1em; /* Adjusted base size */
        }

        #pedro-image {
            width: 100px; /* Reduzido o tamanho da imagem de Pedro para mobile */
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
        }

        #score-text-content {
            text-align: center; /* Centered text on mobile */
            flex-grow: 1;
        }

        #progresso-msg {
            font-weight: bold;
            color: var(--cor-sucesso);
            margin-top: 5px;
            font-size: 1em; /* Adjusted size */
        }

        /* Boutons de Niveau */
        .nivel-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 1.1em; /* Tamanho base (mobile) */
            color: #fff;
            background-color: var(--cor-principal);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: var(--mobile-font); /* Alterado para Sans-Serif */
            font-weight: bold;
        }
        .nivel-btn span {
            display: flex;
            align-items: center;
        }

        /* NEW: Completed Level Color (Green) */
        .nivel-btn.completed {
            background-color: var(--cor-sucesso);
            cursor: default;
        }
        .nivel-btn.completed:hover:not(:disabled) {
            background-color: #27ae60;
        }

        /* Voltar est BLEU */
        .nivel-btn.voltar-btn {
            background-color: var(--cor-voltar);
            justify-content: center;
        }
        .nivel-btn.voltar-btn:hover {
            background-color: #2980b9;
        }

        .nivel-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .nivel-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            color: #7f8c8d;
        }

        .nivel-btn.completed:disabled {
            background-color: var(--cor-sucesso);
            color: white;
        }
        
        /* Bot√£o de reset global (Home Screen) */
        #btn-reset-global {
            background-color: var(--cor-reset);
            color: white;
            margin: 20px auto 0 auto;
            padding: 10px;
            font-size: 1em;
            font-family: var(--mobile-font); /* Alterado para Sans-Serif */
            justify-content: center;
            display: flex;
            width: 90%; /* Aumentado para preencher mais no mobile */
            max-width: 300px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        /* Visibilidade des Telas */
        .tela-jogo {
            display: none;
            padding-top: 20px;
        }
        
        /* N√≠vel 1: Letras (Damier) */
        #letras-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Mobile: 4 colunas para melhor toque */
            gap: 10px;
            margin-bottom: 20px;
        }
        .letra-quadro {
            height: 60px; /* Aumentado para melhor toque */
            background-color: #f1c40f;
            color: #333;
            font-size: 1.6em; /* Ajuste de tamanho */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s, transform 0.1s;
        }
        .letra-quadro.selecionada {
            background-color: #e67e22;
            transform: scale(0.98);
        }
        .letra-quadro.correta {
            background-color: var(--cor-sucesso);
            color: white;
            pointer-events: none;
        }
        .btn-cancelar {
            padding: 10px 20px;
            background-color: var(--cor-erreur);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--mobile-font);
        }
        
        /* N√≠vel 2: Anagramas */
        #palavra-alvo-container {
            font-size: 2em; /* Ajuste de tamanho */
            font-weight: bold;
            color: var(--cor-principal);
            margin-bottom: 15px;
            letter-spacing: 3px; /* Reduzido o espa√ßamento para mobile */
            min-height: 40px;
        }

        #selecao-atual {
            font-size: 2em; /* Ajuste de tamanho */
            font-weight: bold;
            color: #333;
            min-height: 40px;
            border-bottom: 2px solid #ccc;
            margin-bottom: 20px;
            padding-bottom: 10px;
            letter-spacing: 3px;
            display: flex;
            justify-content: center;
        }

        #anagrama-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .anagrama-letra {
            width: 45px;
            height: 45px;
            background-color: #f1c40f;
            color: #333;
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s, opacity 0.2s;
        }

        /* CORRE√á√ÉO: Garante que as letras invis√≠veis/selecionadas sejam desabilitadas */
        .anagrama-letra.invisivel {
            opacity: 0.3;
            pointer-events: none; 
        }
        
        /* N√≠vel 3 (S√≠labas) */
        #opcoes-silabas {
            display: flex;
            justify-content: space-around;
            gap: 10px; /* Reduzido o gap */
            margin-bottom: 20px;
        }

        #silaba-container {
            background-color: var(--cor-principal);
            color: white;
            padding: 15px 30px;
            margin: 20px auto 30px auto;
            border-radius: 12px;
            display: inline-block;
            font-size: 2.5em; /* Ajuste de tamanho */
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* N√≠vel 4 (Identifica√ß√£o) */
        #identificacao-alvo {
            font-size: 2em; /* Ajuste de tamanho */
            font-weight: bold;
            color: var(--cor-principal);
            margin-bottom: 25px;
        }
        
        /* Op√ß√µes (N√≠veis 3, 4, 5) - Stack vertical em telas estreitas */
        #opcoes-identificacao, #opcoes-palavras {
            display: flex;
            flex-direction: column; /* MOBILE FIRST: Stack vertical */
            gap: 10px; 
            margin-bottom: 20px;
        }
        
        .opcao-btn, .btn-verdadeiro-falso {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid var(--cor-principal);
            background-color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: var(--mobile-font); /* Alterado para Sans-Serif */
            display: block; /* Garante que preenche a largura no stack */
            width: 100%;
        }

        #opcoes-silabas .opcao-btn {
            flex-grow: 1;
            display: inline-block;
            width: auto;
        }
        
        /* N√≠vel 5 (√Åudio) */
        .btn-audio {
            width: auto;
            padding: 10px 20px;
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 8px;
            margin: 10px auto 25px auto;
            display: block;
            cursor: pointer;
            font-size: 1.2em;
            font-family: var(--mobile-font);
            font-weight: bold;
        }
        .btn-audio i {
            margin: 0;
            font-size: 1.4em;
        }

        /* Modal de Confirma√ß√£o */
        #modal-confirmacao {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 90%; /* Ajuste para mobile */
            max-width: 350px;
            border: 1px solid #ccc;
        }
        #modal-confirmacao p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        .botoes-modal {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        #btn-sim-reset-global, #btn-nao {
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            flex-grow: 1;
            font-family: var(--mobile-font);
            font-weight: bold;
        }
        #btn-sim-reset-global {
            background-color: var(--cor-reset);
            color: white;
        }
        #btn-nao {
            background-color: var(--cor-voltar);
            color: white;
        }
        
        /* --- ESTILOS DE RESPONSIVIDADE (Ajustes para telas maiores que mobile padr√£o) --- */
        @media (min-width: 600px) {
            /* Desktop/Tablet - Reverte alguns mobile-first stacks */
            #score-container {
                flex-direction: row; /* Volta para lado a lado */
                text-align: left;
                gap: 15px;
                font-size: 1.1em;
            }
            #pedro-image {
                width: 150px;
                height: 150px;
            }
            #score-text-content {
                text-align: left;
            }
            #letras-grid {
                 /* Em telas maiores, 3 colunas pode ser mais est√©tico */
                grid-template-columns: repeat(3, 1fr);
            }
            #opcoes-identificacao,
            #opcoes-palavras {
                /* Em telas maiores, volta para op√ß√µes lado a lado */
                flex-direction: row;
            }
            #opcoes-identificacao .opcao-btn, #opcoes-palavras .opcao-btn {
                flex-grow: 1;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
<div id="modal-confirmacao" style="display: none;">
    <p id="modal-reset-text">Voc√™ vai perder todos os pontos do N√≠vel 3 (S√≠labas). Quer mesmo recome√ßar?</p>
    <div class="botoes-modal">
        <button id="btn-sim-reset-global" onclick="confirmaRecomeco(true)">Sim</button>
        <button id="btn-nao" onclick="cancelaRecomeco()">N√£o</button>
    </div>
</div>

<div class="container">
    <div id="tela-home" class="tela-jogo" style="display: block;">
        <h1>Oi Pedro! Vamos estudar!</h1>

        <div id="score-container">
            <img id="pedro-image" src="https://regine-lambrecht.github.io/leitura/Pedro.png" alt="Pedro Icon">

            <div id="score-text-content">
                <p>CONQUISTAS: <span id="score-valor">34</span> / 64 PONTOS!</p>
                <p id="progresso-msg">MUITO BEM! SUA LEITURA EST√Å VOANDO ALTO! üéà</p>
            </div>
        </div>

        <button class="nivel-btn completed" id="btn-nivel-1" onclick="iniciarNivel(1)" disabled="">
            <span class="content-left-group">Letras (pares) <span class="icon-container"><i class="fa-solid fa-trophy"></i></span></span>
            <span class="contador-progresso" id="count-n1">(4/4)</span>
        </button>

        <button class="nivel-btn completed" id="btn-nivel-2" onclick="iniciarNivel(2)" disabled="">
            <span class="content-left-group">Letras de palavras <span class="icon-container"><i class="fa-solid fa-trophy"></i><i class="fa-solid fa-trophy"></i></span></span>
            <span class="contador-progresso" id="count-n2">(10/10)</span>
        </button>

        <button class="nivel-btn" id="btn-nivel-3" onclick="iniciarNivel(3)">
            <span class="content-left-group">S√≠labas <span class="icon-container"><i class="fa-solid fa-eye"></i></span></span>
            <span class="contador-progresso" id="count-n3">(0/20)</span>
        </button>

        <button class="nivel-btn" id="btn-nivel-4" onclick="iniciarNivel(4)">
            <span class="content-left-group">Identifica√ß√£o <span class="icon-container"><i class="fa-solid fa-medal"></i></span></span>
            <span class="contador-progresso" id="count-n4">(0/20)</span>
        </button>

        <button class="nivel-btn" id="btn-nivel-5" onclick="iniciarNivel(5)" disabled="">
            <span class="content-left-group">Palavras (√°udio) <span class="icon-container"><i class="fa-solid fa-graduation-cap"></i></span></span>
            <span class="contador-progresso" id="count-n5">(0/10)</span>
        </button>

        <button id="btn-reset-global" onclick="mostrarModalRecomeco('global')" style="display: flex;">
            <i class="fa-solid fa-sync-alt"></i> RECOME√áAR TUDO DE ZERO
        </button>
    </div>

    <div id="tela-nivel-1" class="tela-jogo" style="display: none;">
        <h2>Letras (Pares)</h2>
        <p>Encontre os 6 pares (Mai√∫scula e min√∫scula).</p>
        <div id="letras-grid"></div>
        <button class="btn-cancelar" onclick="cancelarSelecaoNivel1()">Cancelar</button>
        <button class="nivel-btn voltar-btn" onclick="mostrarTela('home')">Voltar</button>
    </div>

    <div id="tela-nivel-2" class="tela-jogo" style="display: none;">
        <h2>Letras de Palavras</h2>
        <p>Monte a palavra em MAI√öSCULAS na ordem correta.</p>

        <div id="palavra-alvo-container"></div>

        <div id="selecao-atual"></div>

        <div id="anagrama-grid"></div>

        <button class="btn-cancelar" id="btn-cancelar-anagrama" onclick="cancelarSelecaoNivel2()">Cancelar</button>
        <button class="nivel-btn voltar-btn" onclick="mostrarTela('home')">Voltar</button>
    </div>

    <div id="tela-nivel-3" class="tela-jogo" style="display: none;">
        <h2>S√≠labas</h2>

        <h3>Qual √© a silaba em minusculas?</h3>

        <div id="silaba-container">
            <span id="silaba-maiuscula">PE</span>
        </div>

        <div id="opcoes-silabas"><button class="opcao-btn">pm</button><button class="opcao-btn">le</button><button class="opcao-btn">pe</button></div>
        <button class="nivel-btn voltar-btn" onclick="mostrarTela('home')">Voltar</button>
    </div>

    <div id="tela-nivel-4" class="tela-jogo" style="display: none;">
        <h2>Identifica√ß√£o de Palavras</h2>
        <p>Encontre a palavra em min√∫sculas que corresponde √† palavra MAI√öSCULA.</p>

        <div id="identificacao-alvo">L√ÅPIS</div>

        <div id="opcoes-identificacao"><button class="opcao-btn">l√°pis</button><button class="opcao-btn">peixe</button><button class="opcao-btn">urubu</button></div>

        <button class="nivel-btn voltar-btn" onclick="mostrarTela('home')">Voltar</button>
    </div>

    <div id="tela-nivel-5" class="tela-jogo" style="display: none;">
        <h2>Palavras (√Åudio)</h2>
        <p>Escute a palavra e a encontre entre les options.</p>
        <button class="btn-audio" onclick="falarPalavraAtual()"><i class="fa-solid fa-volume-up"></i></button>
        <div id="opcoes-palavras"></div>
        <button class="nivel-btn voltar-btn" onclick="mostrarTela('home')">Voltar</button>
    </div>
</div>

<div id="browser-voice-control"></div>
<script>
    // Configura√ß√£o das vozes TTS
    const synth = window.speechSynthesis;
    let brazilVoice = null;

    function setupVoice() {
        const voices = synth.getVoices();
        brazilVoice = voices.find(voice => voice.lang === 'pt-BR') || voices[0];
    }

    if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = setupVoice;
    } else {
        setupVoice();
    }

    function falarTexto(texto) {
        if (synth.speaking) {
            synth.cancel();
        }
        const utterance = new SpeechSynthesisUtterance(texto);
        utterance.lang = 'pt-BR';
        utterance.rate = 0.8;
        if (brazilVoice) {
            utterance.voice = brazilVoice;
        }
        synth.speak(utterance);
    }

    // --- DADOS DU JEU (PALAVRAS E DEFINI√á√ïES SIMPLIFICADAS) ---
    const DADOS_LETRAS = [
        ['A', 'a', 'E', 'e', 'I', 'i', 'O', 'o', 'U', 'u', 'Y', 'y'],
        ['B', 'b', 'D', 'd', 'P', 'p', 'Q', 'q', 'R', 'r', 'V', 'v'],
        ['C', 'c', 'F', 'f', 'G', 'g', 'H', 'h', 'J', 'j', 'T', 't'],
        ['K', 'k', 'L', 'l', 'M', 'm', 'N', 'n', 'S', 's', 'X', 'x']
    ];
    
    // Final list of 60 words for all levels
    let PALAVRAS_BASE = [
        "Professor", "Jabuti", "Galinha", "Diploma", "Chiclete", "Peixe", "Quatro", "Foguete", "Barata", "Quadro",
        "Abelha", "Aranha", "Arara", "Baleia", "Banana", "Bolacha", "Boliche", "Brasil", "Cabide", "Cabine",
        "Cachorro", "Caneta", "Casada", "Chap√©u", "Chave", "Chupeta", "Chuva", "Cobra", "Coelho", "Cofre",
        "Doming√£o", "Festejar", "Golfinho", "Invejar", "L√°bio", "L√°pis", "Le√£o", "Letra", "Livro", "Ma√ß√£",
        "Macaco", "Navio", "On√ßa", "Peito", "Peteca", "Planejar", "Planilha", "Porco", "Porta", "Prato",
        "Sacada", "Salada", "Sapato", "Sorriso", "Sorvete", "Tapete", "Vaca", "Telhado", "Tomada", "Urubu"
    ];
    let PALAVRAS = PALAVRAS_BASE.map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());

    // --- N√çVEL 3: DADOS HARD-CODED E PONTUA√á√ÉO SEQUENCIAL ---        
    // Lista Sequencial de S√≠labas (54 elementos) - Gerada da separa√ß√£o das 20 palavras (11 a 30)
    const DESAFIO_SILABAS_SEQUENCIAL = [
        "a", "be", "lha", "a", "ra", "nha", "a", "ra", "ra", "ba", "lei", "a", "ba", "na", "na",
        "bo", "la", "cha", "bo", "li", "che", "bra", "sil", "ca", "bi", "de", "ca", "bi", "ne",
        "ca", "cho", "rro", "ca", "ne", "ta", "ca", "sa", "da", "cha", "p√©u", "cha", "ve",
        "chu", "pe", "ta", "chu", "va", "co", "bra", "co", "e", "lho", "co", "fre"
    ];
    
    // IDs (√çNDICES 1-BASED) que concedem PONTO (Fim da palavra)
    const PONTOS_IDS_N3 = [3, 6, 9, 12, 15, 18, 21, 23, 26, 29, 32, 35, 38, 40, 42, 45, 47, 49, 52, 54];
    
    const MAX_SILABAS_LOOP_N3 = DESAFIO_SILABAS_SEQUENCIAL.length; // 54 s√≠labas no ditado
    const MAX_N3_COMPLETIONS = PONTOS_IDS_N3.length; // 20 pontos a serem alcan√ßados

    // --- FUN√á√ÉO getSilabas() mantida para N√≠vel 4/5 (Gera√ß√£o de distratores) ---
    function getSilabas(palavra) {
        // Esta fun√ß√£o ainda √© necess√°ria para gerar distratores nos N√≠veis 4 e 5.
        let processedPalavra = palavra.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        processedPalavra = processedPalavra.replace(/rr|ss|ch|lh|nh|qu|gu/gi, (match) => match.toUpperCase());
        processedPalavra = processedPalavra.replace(/([aeiouy])([bcdfghjklmnpqrstvwxyz√ß])([aeiouy])/gi, '$1-$2$3');
        processedPalavra = processedPalavra.replace(/([aeiouy])([aeiouy])/gi, '$1-$2');
        processedPalavra = processedPalavra.replace(/([aeiouy])(m|n)([bcdfghjklmnpqrstvwxyz√ß])/gi, '$1$2-$3');
        
        let silabas = processedPalavra.split('-');
        return silabas.map(s => s.trim().toLowerCase()).filter(s => s.length > 0);
    }
    // --- FIM N√çVEL 3 DADOS E L√ìGICA ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function generateSimilarWords(correctWord, allWords) {
        const correctLower = correctWord.toLowerCase();
        const correctSyllabeCount = getSilabas(correctWord).length;

        let candidates = allWords.filter(w => w.toLowerCase() !== correctLower).map(w => ({
            word: w,
            syllableCount: getSilabas(w).length
        }));

        candidates.sort((a, b) =>
            Math.abs(a.syllableCount - correctSyllabeCount) - Math.abs(b.syllableCount - correctSyllabeCount)
        );

        const distractors = [];
        while (distractors.length < 2 && candidates.length > 0) {
            const index = Math.floor(Math.random() * candidates.length);
            const candidate = candidates[index].word;

            if (!distractors.includes(candidate)) {
                distractors.push(candidate);
            }
            candidates.splice(index, 1);
        }

        while (distractors.length < 2) {
             distractors.push(correctWord.length > 3 ? correctWord.substring(0, correctWord.length-1) + 'o' : 'palavra');
        }

        return distractors.slice(0, 2);
    }

    // Total de todos os pontos
    const MAX_N1_COMPLETIONS = DADOS_LETRAS.length; // 4
    const MAX_N2_COMPLETIONS = 10; // Anagramas (Words 1-10)
    const MAX_N4_COMPLETIONS = 20; // NEW: Identification (Words 31-50)
    const MAX_N5_COMPLETIONS = 10; // Palavras √Åudio (Words 51-60)

    function calcularTotalMaximo() {
        return MAX_N1_COMPLETIONS + MAX_N2_COMPLETIONS + MAX_N3_COMPLETIONS + MAX_N4_COMPLETIONS + MAX_N5_COMPLETIONS;
    }

    // --- Variables d'√âtat Global ---
    const INITIAL_GAME_STATE = {
        scoreGlobal: 0,
        progressoNivel1: [0, 0, 0, 0],
        damierAtual: 0,
        selecaoN1: [],

        progressoNivel2: 0,
        palavraAtualN2: null,
        selecaoN2: [],

        progressoNivel3: 0,
        syllabesCompletasPorPalavra: {},
        indiceSilabaAtual: 0, // NOVO: Rastreia a posi√ß√£o no DESAFIO_SILABAS_SEQUENCIAL (√≠ndice 0-based)

        progressoN4: 0, // NEW: Identification
        palavrasCompletasN4: {},

        progressoN5: 0,
        palavrasCompletasN5: {},
    };

    let estadoJogo = {...INITIAL_GAME_STATE};
    let nivelSendoResetado = null;

    let palavraAtual = '';
    let palavraAnteriorN5 = null;

    // --- FUN√á√ïES DE UTILIDADE ET PERSISTENCE ---
    function carregarEstado() {
        const estadoSalvo = localStorage.getItem('aprendendoAleitura');
        if (estadoSalvo) {
            estadoJogo = JSON.parse(estadoSalvo);
            // Garante que os novos estados estejam presentes
            if (estadoJogo.indiceSilabaAtual === undefined) estadoJogo.indiceSilabaAtual = 0;
            if (estadoJogo.progressoNivel3 === undefined) estadoJogo.progressoNivel3 = 0;
            if (!estadoJogo.palavrasCompletasN4) estadoJogo.palavrasCompletasN4 = {};
            if (!estadoJogo.palavrasCompletasN5) estadoJogo.palavrasCompletasN5 = {};
            if (!estadoJogo.syllabesCompletasPorPalavra) estadoJogo.syllabesCompletasPorPalavra = {};
        } else {
            estadoJogo = {...INITIAL_GAME_STATE};
        }
    }

    function salvarEstado() {
        localStorage.setItem('aprendendoAleitura', JSON.stringify(estadoJogo));
    }

    /* MODAL AND RESET LOGIC */
    function mostrarModalRecomeco(nivel) {
        const modalText = document.getElementById('modal-reset-text');
        
        // Apenas permite o reset global
        if (nivel === 'global') {
            modalText.textContent = "Voc√™ vai perder TODOS os pontos e todo o progresso. Quer mesmo recome√ßar de zero?";
            document.getElementById('btn-sim-reset-global').onclick = () => confirmaRecomeco(true);
            nivelSendoResetado = 'global';
            document.getElementById('modal-confirmacao').style.display = 'block';
        } else {
            // Bloqueia tentativas de reset de n√≠vel individual (como solicitado)
            console.warn(`Tentativa de reset de n√≠vel (${nivel}) bloqueada.`);
            return;
        }
    }

    function cancelaRecomeco() {
        document.getElementById('modal-confirmacao').style.display = 'none';
        nivelSendoResetado = null;
    }

    function getHighestIncompleteLevel() {
        if (estadoJogo.progressoNivel1.filter(c => c >= 2).length < MAX_N1_COMPLETIONS) return 1;
        if (estadoJogo.progressoNivel2 < MAX_N2_COMPLETIONS) return 2;
        if (estadoJogo.progressoNivel3 < MAX_N3_COMPLETIONS) return 3;
        if (estadoJogo.progressoN4 < MAX_N4_COMPLETIONS) return 4;
        if (estadoJogo.progressoN5 < MAX_N5_COMPLETIONS) return 5;
        return 5;
    }
    
    // --- FUN√á√ÉO: Recalcula o score global somando todos os progressos ---
    function recalcularScoreGlobal() {
        const n1Score = estadoJogo.progressoNivel1.filter(c => c >= 2).length;
        const n2Score = estadoJogo.progressoNivel2;
        const n3Score = estadoJogo.progressoNivel3;
        const n4Score = estadoJogo.progressoN4;
        const n5Score = estadoJogo.progressoN5;

        estadoJogo.scoreGlobal = n1Score + n2Score + n3Score + n4Score + n5Score;
    }
    // --- FIM FUN√á√ïES DE RECALCULO ---

    function confirmaRecomeco(resetGlobal) {
        cancelaRecomeco();

        if (resetGlobal) {
            estadoJogo = {...INITIAL_GAME_STATE};
            localStorage.removeItem('aprendendoAleitura');
            estadoJogo.indiceSilabaAtual = 0; // Zera o √≠ndice de ditado ao fazer reset global
        } else {
            // Mant√©m a estrutura, mas agora s√≥ o reset global √© chamado com (true)
            mostrarTela('home');
            return;
        }

        atualizarInterfaceHome();
        mostrarTela('home');
    }

    function mostrarTela(nivelId) {
        document.querySelectorAll('.tela-jogo').forEach(tela => tela.style.display = 'none');
        const targetElement = document.getElementById(`tela-${nivelId}`);
        if (targetElement) {
             targetElement.style.display = 'block';
        } else {
             console.error(`Elemento com ID 'tela-${nivelId}' n√£o encontrado.`);
        }

        // Esconde o bot√£o global na tela de jogo, mostra na Home
        document.getElementById('btn-reset-global').style.display = (nivelId === 'home') ? 'flex' : 'none';

        if (nivelId === 'home') {
            atualizarInterfaceHome();
        }
    }

    // A fun√ß√£o exibirMensagemBravo foi removida conforme solicitado.
    
    // --- L√ìGICA DU SCORE ET PROGRESS√ÉO ---
    function atualizarInterfaceHome() {
        if (PALAVRAS.length === 0) {
              document.querySelector('.container').innerHTML =
                "<h1>Erro de Carregamento</h1><p>N√£o foi poss√≠vel carregar as palavras. O jogo n√£o pode iniciar.</p>";
              return;
        }

        recalcularScoreGlobal();

        // **CORRE√á√ÉO NA EXIBI√á√ÉO DO SCORE GLOBAL**: Garante que o score √© sempre um n√∫mero
        const scoreVal = isNaN(estadoJogo.scoreGlobal) ? 0 : estadoJogo.scoreGlobal;

        // A barra e o total (/ 64 PONTOS!) j√° est√£o no HTML.
        document.getElementById('score-valor').textContent = scoreVal;

        verificarMensagemProgresso(estadoJogo.scoreGlobal);
        atualizarBotoesNivel();
        salvarEstado();
    }

    function adicionarPonto() {
        atualizarInterfaceHome();
    }

    function atualizarBotoesNivel() {
        const damierComplet = estadoJogo.progressoNivel1.filter(c => c >= 2).length;

        const btnN1 = document.getElementById('btn-nivel-1');
        const btnN2 = document.getElementById('btn-nivel-2');
        const btnN3 = document.getElementById('btn-nivel-3');
        const btnN4 = document.getElementById('btn-nivel-4');
        const btnN5 = document.getElementById('btn-nivel-5');

        // --- NIVEAU 1 (Letras) ---
        const n1Completed = damierComplet === MAX_N1_COMPLETIONS;
        document.getElementById('count-n1').textContent = `(${damierComplet}/${MAX_N1_COMPLETIONS})`;
        btnN1.disabled = n1Completed;
        if (n1Completed) btnN1.classList.add('completed'); else btnN1.classList.remove('completed');

        // --- NIVEAU 2 (Anagramas) ---
        const n2Completed = estadoJogo.progressoNivel2 >= MAX_N2_COMPLETIONS;
        btnN2.disabled = !n1Completed || n2Completed;
        document.getElementById('count-n2').textContent = `(${estadoJogo.progressoNivel2}/${MAX_N2_COMPLETIONS})`;
        if (n2Completed) btnN2.classList.add('completed'); else btnN2.classList.remove('completed');

        // --- NIVEAU 3 (S√≠labas) ---
        const n3Completed = estadoJogo.progressoNivel3 >= MAX_N3_COMPLETIONS;
        // CORRE√á√ÉO: Habilita o N√≠vel 3 se N2 estiver completo.
        btnN3.disabled = !n2Completed || n3Completed; 
        btnN3.querySelector('.contador-progresso').textContent = `(${Math.min(estadoJogo.progressoNivel3, MAX_N3_COMPLETIONS)}/${MAX_N3_COMPLETIONS})`;
        if (n3Completed) btnN3.classList.add('completed'); else btnN3.classList.remove('completed');

        // --- NIVEAU 4 (Identifica√ß√£o) ---
        const n4Completed = estadoJogo.progressoN4 >= MAX_N4_COMPLETIONS;
        btnN4.disabled = !n3Completed || n4Completed;
        btnN4.querySelector('.contador-progresso').textContent = `(${Math.min(estadoJogo.progressoN4, MAX_N4_COMPLETIONS)}/${MAX_N4_COMPLETIONS})`;
        if (n4Completed) btnN4.classList.add('completed'); else btnN4.classList.remove('completed');

        // --- NIVEAU 5 (Palavras √Åudio) ---
        const n5Completed = estadoJogo.progressoN5 >= MAX_N5_COMPLETIONS;
        btnN5.disabled = !n4Completed || n5Completed;
        btnN5.querySelector('.contador-progresso').textContent = `(${Math.min(estadoJogo.progressoN5, MAX_N5_COMPLETIONS)}/${MAX_N5_COMPLETIONS})`;
        if (n5Completed) btnN5.classList.add('completed'); else btnN5.classList.remove('completed');
    }

    function verificarMensagemProgresso(score) {
        const totalMaximo = calcularTotalMaximo();
        const ratio = score / totalMaximo;
        let message = "";

        if (ratio >= 0.9) {
            message = "Voc√™ √© um mestre da leitura! Woohoo! ü•≥";
        } else if (ratio >= 0.7) {
            message = "Voc√™ est√° arrasando! Continue assim, Campe√£o! üöÄ";
        } else if (ratio >= 0.5) {
            message = "Muito bem! Sua leitura est√° voando alto! üéà";
        } else if (ratio >= 0.3) {
            message = "Opa! Estamos no caminho certo! Vamos l√°! üëç";
        } else {
            // Caso score 0 ou baixo
            message = "Continue praticando! Voc√™ vai pegar o jeito! üí™";
        }

        document.getElementById('progresso-msg').textContent = message.toUpperCase();
    }

    // --- N√çVEL 1: LETRAS (DAMIER) ---
    const PALAVRAS_N2 = PALAVRAS.slice(0, MAX_N2_COMPLETIONS); 

    function iniciarNivel(nivel) {
        if (PALAVRAS.length === 0) {
              document.querySelector('.container').innerHTML =
                "<h1>Erro</h1><p>N√£o foi poss√≠vel iniciar o n√≠vel. O jogo n√£o carregou as palavras.</p>";
              return;
        }

        const btnId = `btn-nivel-${nivel}`;
        const btn = document.getElementById(btnId);

        // **FINAL FIX**: Only run the sequential check IF the button is currently disabled.
        if (nivel > 1 && btn && btn.disabled) {
            // If the button is disabled, the system MUST check if the previous level is complete.
            const nivelAnterior = nivel - 1;
            const progressos = [
                estadoJogo.progressoNivel1.filter(c => c >= 2).length,
                estadoJogo.progressoNivel2,
                estadoJogo.progressoNivel3,
                estadoJogo.progressoN4,
                estadoJogo.progressoN5
            ];
            const maximos = [MAX_N1_COMPLETIONS, MAX_N2_COMPLETIONS, MAX_N3_COMPLETIONS, MAX_N4_COMPLETIONS, MAX_N5_COMPLETIONS];

            // If the preceding level's score is less than maximum, return to home.
            if (progressos[nivelAnterior - 1] < maximos[nivelAnterior - 1]) {
                mostrarTela('home');
                return;
            }
        }
        
        // If the button is blue (active) or the lock check passed, proceed to start the game.
        mostrarTela(`nivel-${nivel}`);
        switch (nivel) {
            case 1: iniciarNivel1(); break;
            case 2: iniciarNivel2(); break;
            case 3: iniciarNivel3(); break; 
            case 4: iniciarNivel4(); break;
            case 5: iniciarNivel5(); break;
        }
    }

    // N√çVEL 1 LOGIC
    function iniciarNivel1() {
        paresCorretosN1 = 0;
        estadoJogo.selecaoN1 = [];

        if (estadoJogo.progressoNivel1.filter(c => c >= 2).length === DADOS_LETRAS.length) {
            mostrarTela('home'); return;
        }

        let indexToLoad = estadoJogo.damierAtual % DADOS_LETRAS.length;

        let startCheck = indexToLoad;
        while (estadoJogo.progressoNivel1[indexToLoad] >= 2) {
            indexToLoad = (indexToLoad + 1) % DADOS_LETRAS.length;
            if (indexToLoad === startCheck) {
                 mostrarTela('home'); return;
             }
        }

        estadoJogo.damierAtual = indexToLoad;

        const damier = DADOS_LETRAS[estadoJogo.damierAtual];
        const melange = [...damier].sort(() => Math.random() - 0.5);

        const grid = document.getElementById('letras-grid');
        grid.innerHTML = '';

        melange.forEach(letra => {
            const caseElement = document.createElement('div');
            caseElement.textContent = letra;
            caseElement.className = 'letra-quadro';
            caseElement.dataset.letra = letra;
            caseElement.onclick = () => selecionarLetra(caseElement);
            grid.appendChild(caseElement);
        });
    }

    function selecionarLetra(element) {
        if (element.classList.contains('correta') || estadoJogo.selecaoN1.length >= 2) return;

        if (estadoJogo.selecaoN1.includes(element)) return;

        element.classList.add('selecionada');
        estadoJogo.selecaoN1.push(element);

        if (estadoJogo.selecaoN1.length === 2) {
            verificarPares();
        }
    }

    function cancelarSelecaoNivel1() {
        if (estadoJogo.selecaoN1.length >= 1) {
            const lastElement = estadoJogo.selecaoN1.pop();
            if (lastElement) {
                lastElement.classList.remove('selecionada');
            }
        }
    }

    function verificarPares() {
        const [elem1, elem2] = estadoJogo.selecaoN1;
        const l1 = elem1.dataset.letra;
        const l2 = elem2.dataset.letra;
        const isPair = (l1.toLowerCase() === l2.toLowerCase()) && (l1 !== l2);

        if (isPair) {
            paresCorretosN1++;

            elem1.classList.add('correta');
            elem2.classList.add('correta');
            elem1.classList.remove('selecionada');
            elem2.classList.remove('selecionada');

            if (paresCorretosN1 === 6) {
                sucessoNivel1();
            }
        } else {
            setTimeout(() => {
                elem1.classList.remove('selecionada');
                elem2.classList.remove('selecionada');
            }, 1000);
        }
        estadoJogo.selecaoN1 = [];
        salvarEstado();
    }

    function sucessoNivel1() {
        const currentCount = estadoJogo.progressoNivel1[estadoJogo.damierAtual];
        const currentDamierIndex = estadoJogo.damierAtual;

        estadoJogo.progressoNivel1[currentDamierIndex]++;
        const didJustCompleteTwice = (currentCount === 1) && (estadoJogo.progressoNivel1[currentDamierIndex] === 2);

        estadoJogo.damierAtual = (currentDamierIndex + 1) % DADOS_LETRAS.length;

        if (estadoJogo.progressoNivel1.filter(c => c >= 2).length === DADOS_LETRAS.length) {
            mostrarTela('home');
        } else {
            iniciarNivel1();
        }

        salvarEstado();
        atualizarInterfaceHome();
    }
    
    // --- N√çVEL 2: LETRAS DE PALAVRAS (ANAGRAMAS) ---

    function iniciarNivel2() {
        if (estadoJogo.progressoNivel2 >= MAX_N2_COMPLETIONS) {
            mostrarTela('home');
            return;
        }

        const wordIndex = estadoJogo.progressoNivel2 % MAX_N2_COMPLETIONS;
        const targetWord = PALAVRAS_N2[wordIndex];

        estadoJogo.palavraAtualN2 = targetWord;
        estadoJogo.selecaoN2 = [];

        // 1. Set STATIC target word
        document.getElementById('palavra-alvo-container').textContent = targetWord.toUpperCase();

        // 2. Clear selected letters container
        document.getElementById('selecao-atual').textContent = '';

        // 3. Prepare anagram grid
        const letters = targetWord.toLowerCase().split('');
        const shuffledLetters = shuffleArray(letters);

        const grid = document.getElementById('anagrama-grid');
        grid.innerHTML = '';

        shuffledLetters.forEach((letter, index) => {
            const letterElement = document.createElement('div');
            letterElement.textContent = letter;
            letterElement.className = 'anagrama-letra';
            letterElement.dataset.originalIndex = index;
            letterElement.onclick = () => selecionarLetraNova(letterElement, letter);
            grid.appendChild(letterElement);
        });

        document.getElementById('btn-cancelar-anagrama').disabled = true;
    }

    function selecionarLetraNova(element, letter) {
        const selectedContainer = document.getElementById('selecao-atual');
        const targetWord = estadoJogo.palavraAtualN2.toLowerCase();
        const targetLength = targetWord.length;

        if (estadoJogo.selecaoN2.length >= targetLength) return;

        estadoJogo.selecaoN2.push({ element: element, letter: letter });
        element.classList.add('invisivel'); 

        // Update selection display
        const selectedWordSoFar = estadoJogo.selecaoN2.map(item => item.letter.toUpperCase()).join('');
        selectedContainer.textContent = selectedWordSoFar;

        document.getElementById('btn-cancelar-anagrama').disabled = false;

        if (estadoJogo.selecaoN2.length === targetLength) {
            document.getElementById('btn-cancelar-anagrama').disabled = true; // Disable cancel when full
            verificarAnagrama();
        }
    }

    function cancelarSelecaoNivel2() {
        const lastSelection = estadoJogo.selecaoN2.pop();
        if (lastSelection) {
            lastSelection.element.classList.remove('invisivel');

            const selectedContainer = document.getElementById('selecao-atual');
            const selectedWordSoFar = estadoJogo.selecaoN2.map(item => item.letter.toUpperCase()).join('');
            selectedContainer.textContent = selectedWordSoFar;

            if (estadoJogo.selecaoN2.length === 0) {
                 document.getElementById('btn-cancelar-anagrama').disabled = true;
            }
        }
    }

    function verificarAnagrama() {
        const selectedWord = estadoJogo.selecaoN2.map(item => item.letter).join('');
        const targetWord = estadoJogo.palavraAtualN2.toLowerCase();

        if (selectedWord === targetWord) {
            estadoJogo.progressoNivel2++;

            if (estadoJogo.progressoNivel2 >= MAX_N2_COMPLETIONS) {
                mostrarTela('home');
            } else {
                // PARTIAL SUCCESS: Use setTimeout para garantir a estabilidade
                setTimeout(iniciarNivel2, 100);
            }
        } else {
            setTimeout(() => {
                estadoJogo.selecaoN2.forEach(item => item.element.classList.remove('invisivel'));
                estadoJogo.selecaoN2 = [];
                document.getElementById('selecao-atual').textContent = ''; // Reset display
                document.getElementById('btn-cancelar-anagrama').disabled = true;
            }, 1000);
        }
        salvarEstado();
        atualizarInterfaceHome();
    }

    // --- N√çVEL 3: S√çLABAS (REESCRITO) ---

    function generateDistractorsSilabas(correct) {
        // ... (Distractor generation logic remains the same for variety)
        const correctLower = correct.toLowerCase();
        let distractors = [];
        const alphabet = 'bcdefghijklmnpqrstvwxyz';

        for (let i = 0; i < correctLower.length; i++) {
            const originalChar = correctLower[i];
            const randomChar = alphabet[Math.floor(Math.random() * alphabet.length)];

            if (!'aeiou√£√µ'.includes(originalChar) && randomChar !== originalChar) {
                const distractor = correctLower.substring(0, i) + randomChar + correctLower.substring(i + 1);
                if (distractor !== correctLower && !distractors.includes(distractor) && distractors.length < 2) {
                    distractors.push(distractor);
                }
            }
        }
        while (distractors.length < 2) {
            let uniqueDistractor = correctLower.substring(0, correctLower.length - 1) + alphabet[Math.floor(Math.random() * alphabet.length)] + (correctLower.length > 2 ? 'a' : '');
            if (!distractors.includes(uniqueDistractor) && uniqueDistractor.length >= 2) {
                 distractors.push(uniqueDistractor);
            } else if (distractors.length === 0) {
                distractors.push('tepo');
            }
        }
        return distractors.slice(0, 2);
    }

    let silabaAtual = '';

    function iniciarNivel3() {
        // 1. Check for Level Completion
        if (estadoJogo.progressoNivel3 >= MAX_N3_COMPLETIONS) {
            mostrarTela('home');
            return;
        }

        // 2. SET STARTING INDEX BASED ON CURRENT SCORE (WORD COUNT)
        const currentWordCount = estadoJogo.progressoNivel3;

        let startIndex;
        if (currentWordCount === 0) {
            // IF score is 0, start at index 0 (the first syllable: "a" from "abelha")
            startIndex = 0;
        } else {
            // IF score is > 0, calculate the index immediately after the last solved word.
            // PONTOS_IDS_N3 is 1-based, we subtract 1 to get the array index of the last point.
            // The value at that index is the syllable ID (1-based), which equals the next 0-based index.
            const lastCompletedIndex_1based = PONTOS_IDS_N3[currentWordCount - 1]; 
            startIndex = lastCompletedIndex_1based;
        }
        
        estadoJogo.indiceSilabaAtual = startIndex;
        salvarEstado(); 
        // --- END UNBREAKABLE START LOGIC ---


        // 3. --- CORE LOGIC ---
        // Ensure index is safe before access (essential for crash prevention)
        let safeIndex = parseInt(estadoJogo.indiceSilabaAtual);
        if (isNaN(safeIndex) || safeIndex < 0 || safeIndex >= MAX_SILABAS_LOOP_N3) {
            // Emergency brake: reset to 0 if data is corrupt/non-numeric
            safeIndex = 0;
            estadoJogo.indiceSilabaAtual = 0;
            salvarEstado();
        }

        const currentIndex = safeIndex % MAX_SILABAS_LOOP_N3;
        silabaAtual = DESAFIO_SILABAS_SEQUENCIAL[currentIndex];

        document.getElementById('silaba-maiuscula').textContent = silabaAtual.toUpperCase();

        const optionsDiv = document.getElementById('opcoes-silabas');
        optionsDiv.innerHTML = '';

        const options = [silabaAtual, ...generateDistractorsSilabas(silabaAtual)];
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opcao-btn';
            btn.textContent = opt;
            btn.onclick = () => verificarSilaba(opt);
            optionsDiv.appendChild(btn);
        });
    }

    function verificarSilaba(selection) {
        if (selection === silabaAtual) {

            // CHECK IF THIS SYLLABLE IS THE END OF A WORD (1 point per word solved)
            const currentId = estadoJogo.indiceSilabaAtual + 1; 

            if (PONTOS_IDS_N3.includes(currentId)) {
                // If it is the end of a word, grant 1 point (Max 20)
                if (estadoJogo.progressoNivel3 < MAX_N3_COMPLETIONS) {
                    estadoJogo.progressoNivel3++;
                }
            }

            // ADVANCE TO THE NEXT SYLLABLE IN THE SEQUENCE
            estadoJogo.indiceSilabaAtual = (estadoJogo.indiceSilabaAtual + 1) % MAX_SILABAS_LOOP_N3;

            if (estadoJogo.progressoNivel3 === MAX_N3_COMPLETIONS) {
                mostrarTela('home');
                return;
            }

            // SUCCESS: Advance to the next syllable/word challenge
            setTimeout(iniciarNivel3, 100);

        } else {
            // FAILURE: REPEAT THE CURRENT SYLLABLE (Index does not change)
            setTimeout(iniciarNivel3, 100);
        }
        salvarEstado();
        atualizarInterfaceHome();
    }
    // --- FIM N√çVEL 3 L√ìGICA (RECODIFICADO) ---


    // --- N√çVEL 4: IDENTIFICA√á√ÉO DE PALAVRAS ---
    function iniciarNivel4() {
        if (estadoJogo.progressoN4 >= MAX_N4_COMPLETIONS) {
            mostrarTela('home');
            return;
        }

        // Filter words to indices 31 through 50 (20 words total)
        const PALAVRAS_PARA_N4 = PALAVRAS.slice(30, 50);
        if (PALAVRAS_PARA_N4.length === 0) {
            mostrarTela('home');
            return;
        }

        // Filter words that have NOT been completed once yet
        const palavrasDisponiveisN4 = PALAVRAS_PARA_N4.filter(p => {
             return (estadoJogo.palavrasCompletasN4[p.toLowerCase()] || 0) < 1;
        });

        const palavrasCandidatasSource = palavrasDisponiveisN4.length > 0 ? palavrasDisponiveisN4 : PALAVRAS_PARA_N4;

        const targetWord = palavrasCandidatasSource[Math.floor(Math.random() * palavrasCandidatasSource.length)];
        palavraAtual = targetWord; // Set global word for scoring

        // 1. Set the target word in UPPERCASE
        document.getElementById('identificacao-alvo').textContent = targetWord.toUpperCase();

        // 2. Generate options (1 correct, 2 distractors)
        // Distractors are drawn from the full PALAVRAS list for variety
        const distractors = generateSimilarWords(targetWord, PALAVRAS);
        let options = [targetWord, ...distractors];
        options = shuffleArray(options);

        const optionsDiv = document.getElementById('opcoes-identificacao');
        optionsDiv.innerHTML = '';

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opcao-btn';
            btn.textContent = opt.toLowerCase(); // Options in lowercase
            btn.onclick = () => verificarPalavraVisual(opt);
            optionsDiv.appendChild(btn);
        });

        salvarEstado();
    }

    function verificarPalavraVisual(selection) {
        if (selection.toLowerCase() === palavraAtual.toLowerCase()) {
            const key = palavraAtual.toLowerCase();

            if ((estadoJogo.palavrasCompletasN4[key] || 0) === 0) {
                estadoJogo.palavrasCompletasN4[key] = 1;

                if (estadoJogo.progressoN4 < MAX_N4_COMPLETIONS) {
                    estadoJogo.progressoN4++;
                }
            }

            if (estadoJogo.progressoN4 === MAX_N4_COMPLETIONS) {
                mostrarTela('home');
                return;
            }

            // PARTIAL SUCCESS: Use setTimeout para garantir a estabilidade
            setTimeout(iniciarNivel4, 100);
        } else {
            // FAILURE: Use setTimeout para garantir a estabilidade
            setTimeout(iniciarNivel4, 100);
        }
        salvarEstado();
        atualizarInterfaceHome();
    }

    // --- N√çVEL 5: PALAVRAS (√ÅUDIO) ---
    function iniciarNivel5() {
        if (estadoJogo.progressoN5 >= MAX_N5_COMPLETIONS) {
            mostrarTela('home');
            return;
        }

        // Filter words to indices 51 through 60 (10 words total)
        const PALAVRAS_PARA_N5 = PALAVRAS.slice(50, 60);
        if (PALAVRAS_PARA_N5.length === 0) {
            mostrarTela('home');
            return;
        }

        // Filter words that have NOT been completed once yet
        const palavrasDisponiveisN5 = PALAVRAS_PARA_N5.filter(p => {
             return (estadoJogo.palavrasCompletasN5[p.toLowerCase()] || 0) < 1;
        });

        const palavrasCandidatasSource = palavrasDisponiveisN5.length > 0 ? palavrasDisponiveisN5 : PALAVRAS_PARA_N5;

        const distractorsSource = PALAVRAS;

        // LOGIC FIX: Prevent consecutive repetition
        let palavrasCandidatas = [...palavrasCandidatasSource];
        if (palavrasCandidatas.length > 1 && palavraAnteriorN5) {
             palavrasCandidatas = palavrasCandidatas.filter(p => p.toLowerCase() !== palavraAnteriorN5);
             if (palavrasCandidatas.length === 0) {
                 palavrasCandidatas = palavrasCandidatasSource;
             }
        }

        palavraAtual = palavrasCandidatas[Math.floor(Math.random() * palavrasCandidatas.length)];
        palavraAnteriorN5 = palavraAtual.toLowerCase();

        const distractors = generateSimilarWords(palavraAtual, distractorsSource);
        let options = [palavraAtual, ...distractors];
        options = shuffleArray(options);

        const optionsDiv = document.getElementById('opcoes-palavras');
        optionsDiv.innerHTML = '';

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opcao-btn';
            btn.textContent = opt.charAt(0).toUpperCase() + opt.slice(1).toLowerCase();
            btn.onclick = () => verificarPalavraAudio(opt);
            optionsDiv.appendChild(btn);
        });

        setTimeout(falarPalavraAtual, 500);
    }

    function falarPalavraAtual() {
        if (palavraAtual) {
            falarTexto(palavraAtual);
        }
    }

    function verificarPalavraAudio(selection) {
        if (selection.toLowerCase() === palavraAtual.toLowerCase()) {
            const key = palavraAtual.toLowerCase();

            if ((estadoJogo.palavrasCompletasN5[key] || 0) === 0) {
                estadoJogo.palavrasCompletasN5[key] = 1;

                if (estadoJogo.progressoN5 < MAX_N5_COMPLETIONS) {
                    estadoJogo.progressoN5++;
                }
            }

            if (estadoJogo.progressoN5 === MAX_N5_COMPLETIONS) {
                mostrarTela('home');
                return;
            }

            // PARTIAL SUCCESS: Use setTimeout para garantir a estabilidade
            setTimeout(iniciarNivel5, 100);

        } else {
            // FAILURE: Use setTimeout para garantir a estabilidade
            setTimeout(iniciarNivel5, 100);
        }
        salvarEstado();
        atualizarInterfaceHome();
    }

    async function inicializarJogo() {
        carregarEstado();
        
        // --- PATCH: Ensure Level 2 completion so Level 3 unlocks. ---
        const MAX_N1_COMPLETIONS = DADOS_LETRAS.length;
        const n1Completed = estadoJogo.progressoNivel1.filter(c => c >= 2).length === MAX_N1_COMPLETIONS;
        
        // If Level 1 is complete, ensure Level 2 is marked complete (10/10) so Level 3 unlocks.
        if (n1Completed && estadoJogo.progressoNivel2 < MAX_N2_COMPLETIONS) {
            estadoJogo.progressoNivel2 = MAX_N2_COMPLETIONS;
            salvarEstado(); 
        }

        // --- END PATCH ---

        atualizarInterfaceHome();
    }

    // --- INITIALISATION ---
    document.addEventListener('DOMContentLoaded', inicializarJogo);
</script>
</body>
</html>
